<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Token Debug Tool</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .token-item { margin: 10px 0; padding: 10px; border: 1px solid #ddd; border-radius: 5px; }
        .valid { background-color: #d4edda; border-color: #c3e6cb; }
        .invalid { background-color: #f8d7da; border-color: #f5c6cb; }
        .null { background-color: #e2e3e5; border-color: #d6d8db; }
        button { margin: 5px; padding: 10px 15px; }
    </style>
</head>
<body>
    <h1>üîç Token Debug Tool</h1>
    <p>This tool helps debug authentication token issues with the charging station upload system.</p>
    
    <div id="tokenStatus"></div>
    
    <h3>Actions:</h3>
    <button onclick="refreshTokens()">üîÑ Refresh Token Status</button>
    <button onclick="clearAllTokens()">üóëÔ∏è Clear All Tokens</button>
    <button onclick="testAPI()">üß™ Test Presigned Upload API</button>

    <h3>Set Test Token:</h3>
    <input type="text" id="tokenInput" placeholder="Paste your JWT token here" style="width: 500px;">
    <select id="tokenType">
        <option value="merchantToken">merchantToken</option>
        <option value="employeeToken">employeeToken</option>
        <option value="token">token</option>
    </select>
    <button onclick="setToken()">üíæ Set Token</button>

    <div id="apiResult" style="margin-top: 20px;"></div>

    <script>
        const API_BASE_URL = 'http://localhost:5000/api';

        function getTokenStatus(key) {
            const token = localStorage.getItem(key);
            if (!token || token === 'null' || token === 'undefined') {
                return { status: 'null', value: 'Not set' };
            }
            
            try {
                // Basic JWT validation
                const parts = token.split('.');
                if (parts.length !== 3) {
                    return { status: 'invalid', value: 'Invalid JWT format' };
                }
                
                const payload = JSON.parse(atob(parts[1]));
                const now = Date.now() / 1000;
                
                if (payload.exp && payload.exp < now) {
                    return { status: 'invalid', value: `Expired (${new Date(payload.exp * 1000).toLocaleString()})` };
                }
                
                return { 
                    status: 'valid', 
                    value: `Valid until ${payload.exp ? new Date(payload.exp * 1000).toLocaleString() : 'unknown'}`,
                    payload: payload
                };
            } catch (e) {
                return { status: 'invalid', value: 'Invalid JWT format' };
            }
        }

        function refreshTokens() {
            const tokenKeys = ['merchantToken', 'employeeToken', 'token'];
            const statusDiv = document.getElementById('tokenStatus');
            
            let html = '<h3>üîë Token Status:</h3>';
            
            tokenKeys.forEach(key => {
                const status = getTokenStatus(key);
                const cssClass = status.status;
                html += `
                    <div class="token-item ${cssClass}">
                        <strong>${key}:</strong> 
                        <span>${status.value}</span>
                        ${status.payload ? `<br><small>User: ${status.payload.id || 'N/A'}, Role: ${status.payload.role || 'N/A'}</small>` : ''}
                    </div>
                `;
            });
            
            statusDiv.innerHTML = html;
        }

        function clearAllTokens() {
            const tokenKeys = ['merchantToken', 'employeeToken', 'token'];
            tokenKeys.forEach(key => localStorage.removeItem(key));
            refreshTokens();
            alert('All tokens cleared!');
        }

        function setToken() {
            const token = document.getElementById('tokenInput').value.trim();
            const type = document.getElementById('tokenType').value;
            
            if (!token) {
                alert('Please enter a token');
                return;
            }
            
            localStorage.setItem(type, token);
            document.getElementById('tokenInput').value = '';
            refreshTokens();
            alert(`Token set as ${type}`);
        }

        async function testAPI() {
            const resultDiv = document.getElementById('apiResult');
            resultDiv.innerHTML = '<div>üîÑ Testing API...</div>';
            
            try {
                // Get auth token using the same logic as directS3Upload
                const tokenKeys = ['merchantToken', 'employeeToken', 'token'];
                let authToken = null;
                
                for (const key of tokenKeys) {
                    const token = localStorage.getItem(key);
                    if (token && token !== 'null' && token !== 'undefined') {
                        authToken = token;
                        break;
                    }
                }
                
                if (!authToken) {
                    throw new Error('No valid authentication token found');
                }

                // Test the batch-generate endpoint
                const response = await fetch(`${API_BASE_URL}/presigned-upload/batch-generate`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        files: [
                            {
                                fileName: 'test-image.jpg',
                                fileType: 'image/jpeg',
                                fileSize: 1024000 // 1MB
                            }
                        ],
                        folder: 'Images'
                    })
                });

                const data = await response.json();
                
                if (response.ok) {
                    resultDiv.innerHTML = `
                        <div style="background-color: #d4edda; padding: 10px; border-radius: 5px;">
                            <h4>‚úÖ API Test Successful!</h4>
                            <p>Status: ${response.status}</p>
                            <pre>${JSON.stringify(data, null, 2)}</pre>
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div style="background-color: #f8d7da; padding: 10px; border-radius: 5px;">
                            <h4>‚ùå API Test Failed</h4>
                            <p>Status: ${response.status}</p>
                            <pre>${JSON.stringify(data, null, 2)}</pre>
                        </div>
                    `;
                }
                
            } catch (error) {
                resultDiv.innerHTML = `
                    <div style="background-color: #f8d7da; padding: 10px; border-radius: 5px;">
                        <h4>‚ùå API Test Error</h4>
                        <p>Error: ${error.message}</p>
                    </div>
                `;
            }
        }

        // Auto-refresh on page load
        refreshTokens();
    </script>
</body>
</html>
