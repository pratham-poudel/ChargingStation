<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Device ID Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            line-height: 1.6;
        }
        .test-result {
            background: #f4f4f4;
            padding: 15px;
            margin: 10px 0;
            border-left: 4px solid #007cba;
        }
        .fingerprint {
            background: #e8f5e8;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            font-family: monospace;
            font-size: 14px;
        }
        button {
            background: #007cba;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px 5px;
        }
        button:hover {
            background: #005a8b;
        }
    </style>
</head>
<body>
    <h1>Device ID Generation Test</h1>
    <p>This page tests the device fingerprinting and ID generation logic used in the merchant authentication system.</p>
    
    <button onclick="testDeviceGeneration()">Test Device Generation</button>
    <button onclick="testConsistency()">Test Consistency</button>
    <button onclick="clearStorage()">Clear Storage</button>
    
    <div id="results"></div>

    <script>
        // Device Manager Logic (simplified version)
        const generateDeviceFingerprint = () => {
            return {
                userAgent: navigator.userAgent,
                language: navigator.language,
                languages: navigator.languages ? navigator.languages.join(',') : '',
                screenResolution: `${screen.width}x${screen.height}`,
                availScreenResolution: `${screen.availWidth}x${screen.availHeight}`,
                colorDepth: screen.colorDepth,
                pixelDepth: screen.pixelDepth,
                timezone: new Date().getTimezoneOffset(),
                hardwareConcurrency: navigator.hardwareConcurrency || 'unknown',
                platform: navigator.platform,
                cookieEnabled: navigator.cookieEnabled,
                doNotTrack: navigator.doNotTrack,
                maxTouchPoints: navigator.maxTouchPoints || 0
            };
        };

        const simpleHash = (str) => {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            return Math.abs(hash).toString(16);
        };

        const generateDeviceId = (fingerprint = null) => {
            const fp = fingerprint || generateDeviceFingerprint();
            
            const fingerprintString = [
                fp.userAgent,
                fp.language,
                fp.screenResolution,
                fp.timezone,
                fp.hardwareConcurrency,
                fp.platform,
                fp.colorDepth
            ].join('|');
            
            return simpleHash(fingerprintString);
        };

        const getDeviceName = () => {
            const userAgent = navigator.userAgent;
            const platform = navigator.platform;
            
            let browser = 'Unknown Browser';
            let os = 'Unknown OS';
            
            if (userAgent.includes('Chrome') && !userAgent.includes('Edg')) {
                browser = 'Chrome';
            } else if (userAgent.includes('Firefox')) {
                browser = 'Firefox';
            } else if (userAgent.includes('Safari') && !userAgent.includes('Chrome')) {
                browser = 'Safari';
            } else if (userAgent.includes('Edg')) {
                browser = 'Edge';
            } else if (userAgent.includes('Opera')) {
                browser = 'Opera';
            }
            
            if (userAgent.includes('Windows NT')) {
                os = 'Windows';
            } else if (userAgent.includes('Mac OS X')) {
                os = 'macOS';
            } else if (userAgent.includes('Linux')) {
                os = 'Linux';
            } else if (userAgent.includes('Android')) {
                os = 'Android';
            } else if (userAgent.includes('iPhone') || userAgent.includes('iPad')) {
                os = 'iOS';
            }
            
            return `${browser} on ${os}`;
        };

        const getStoredDeviceId = () => {
            const stored = localStorage.getItem('merchantDeviceId');
            if (stored) {
                try {
                    const deviceData = JSON.parse(stored);
                    const currentFingerprint = generateDeviceFingerprint();
                    const currentDeviceId = generateDeviceId(currentFingerprint);
                    
                    if (deviceData.deviceId === currentDeviceId) {
                        return deviceData;
                    }
                } catch (error) {
                    console.error('Error parsing stored device data:', error);
                }
            }
            
            const fingerprint = generateDeviceFingerprint();
            const deviceId = generateDeviceId(fingerprint);
            const deviceName = getDeviceName();
            
            const deviceData = {
                deviceId,
                deviceName,
                fingerprint,
                createdAt: new Date().toISOString()
            };
            
            localStorage.setItem('merchantDeviceId', JSON.stringify(deviceData));
            
            return deviceData;
        };

        // Test Functions
        function testDeviceGeneration() {
            const results = document.getElementById('results');
            
            const fingerprint = generateDeviceFingerprint();
            const deviceId = generateDeviceId(fingerprint);
            const deviceName = getDeviceName();
            const deviceData = getStoredDeviceId();
            
            results.innerHTML = `
                <div class="test-result">
                    <h3>Device Generation Test Results</h3>
                    <p><strong>Device ID:</strong> ${deviceId}</p>
                    <p><strong>Device Name:</strong> ${deviceName}</p>
                    <p><strong>Created At:</strong> ${new Date().toISOString()}</p>
                    <div class="fingerprint">
                        <strong>Device Fingerprint:</strong><br>
                        ${JSON.stringify(fingerprint, null, 2)}
                    </div>
                    <p><strong>Stored Device Data:</strong></p>
                    <div class="fingerprint">
                        ${JSON.stringify(deviceData, null, 2)}
                    </div>
                </div>
            `;
        }

        function testConsistency() {
            const results = document.getElementById('results');
            
            const tests = [];
            for (let i = 0; i < 5; i++) {
                const deviceId = generateDeviceId();
                tests.push(deviceId);
            }
            
            const allSame = tests.every(id => id === tests[0]);
            
            results.innerHTML = `
                <div class="test-result">
                    <h3>Consistency Test Results</h3>
                    <p><strong>Test Status:</strong> ${allSame ? '✅ PASSED' : '❌ FAILED'}</p>
                    <p><strong>Generated Device IDs:</strong></p>
                    <div class="fingerprint">
                        ${tests.map((id, index) => `Test ${index + 1}: ${id}`).join('<br>')}
                    </div>
                    <p><strong>Analysis:</strong> ${allSame ? 'All device IDs are identical - device fingerprinting is consistent.' : 'Device IDs are different - there may be an issue with fingerprinting consistency.'}</p>
                </div>
            `;
        }

        function clearStorage() {
            localStorage.removeItem('merchantDeviceId');
            const results = document.getElementById('results');
            results.innerHTML = `
                <div class="test-result">
                    <h3>Storage Cleared</h3>
                    <p>Merchant device ID has been cleared from localStorage.</p>
                </div>
            `;
        }

        // Auto-run basic test on load
        window.onload = () => {
            testDeviceGeneration();
        };
    </script>
</body>
</html>
